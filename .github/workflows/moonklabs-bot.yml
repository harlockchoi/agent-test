name: Moonklabs Bot

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue ë²ˆí˜¸"
        required: true
      prompt:
        description: "ìš”ì²­ ë‚´ìš©"
        required: false
        default: ""

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: bot-${{ github.event.issue.number || github.event.inputs.issue_number }}
  cancel-in-progress: false

jobs:
  agent:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' && 
       contains(github.event.comment.body, '@moonklabs-bot'))

    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "moonklabs-bot"
          git config user.email "moonklabs-bot@users.noreply.github.com"
          echo "${{ secrets.GH_PAT }}" | gh auth login --with-token

      - name: Get issue info
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ISSUE_NUMBER="${{ github.event.inputs.issue_number }}"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          fi
          echo "number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          
          ISSUE_DATA=$(gh issue view $ISSUE_NUMBER --json title,body,labels)
          echo "title=$(echo $ISSUE_DATA | jq -r '.title')" >> $GITHUB_OUTPUT

      - name: Add eyes reaction (issue opened)
        if: github.event_name == 'issues'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh api "/repos/${{ github.repository }}/issues/${{ steps.issue.outputs.number }}/reactions" \
            -X POST -f content="eyes" || true

      - name: Add eyes reaction (comment)
        if: github.event_name == 'issue_comment'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh api "/repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions" \
            -X POST -f content="eyes" || true

      - name: Add working label
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh label create "bot: working" --color "fbca04" --force 2>/dev/null || true
          gh issue edit ${{ steps.issue.outputs.number }} --add-label "bot: working" || true

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup tmux
        run: sudo apt-get update && sudo apt-get install -y tmux

      - name: Setup OpenCode
        env:
          OPENCODE_AUTH_JSON: ${{ secrets.OPENCODE_AUTH_JSON }}
        run: |
          curl -fsSL https://opencode.ai/install | bash || true
          export PATH="$HOME/.opencode/bin:$PATH"
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

          mkdir -p ~/.local/share/opencode
          echo "$OPENCODE_AUTH_JSON" > ~/.local/share/opencode/auth.json
          chmod 600 ~/.local/share/opencode/auth.json

          npx oh-my-opencode install --no-tui --claude=max20 --chatgpt=no --gemini=no || true

      - name: Prepare context
        id: context
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            EXTRA_PROMPT=$(echo "$COMMENT_BODY" | sed 's/.*@moonklabs-bot//')
            echo "extra_prompt=$EXTRA_PROMPT" >> $GITHUB_OUTPUT
            echo "trigger=comment" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "extra_prompt=${{ github.event.inputs.prompt }}" >> $GITHUB_OUTPUT
            echo "trigger=manual" >> $GITHUB_OUTPUT
          else
            echo "extra_prompt=" >> $GITHUB_OUTPUT
            echo "trigger=issue_opened" >> $GITHUB_OUTPUT
          fi

      - name: Run AI Agent
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
          ISSUE_TITLE: ${{ steps.issue.outputs.title }}
          EXTRA_PROMPT: ${{ steps.context.outputs.extra_prompt }}
          TRIGGER_TYPE: ${{ steps.context.outputs.trigger }}
          REPO_NAME: ${{ github.repository }}
        run: |
          export PATH="$HOME/.opencode/bin:$PATH"

          FULL_PROMPT=$(cat << 'PROMPT_EOF'
          <ultrawork-mode>
          [CODE RED] Maximum precision required. Ultrathink before acting.

          YOU MUST LEVERAGE ALL AVAILABLE AGENTS TO THEIR FULLEST POTENTIAL.

          ## AGENT UTILIZATION PRINCIPLES
          - **Codebase Exploration**: Spawn exploration agents using BACKGROUND TASKS for file patterns, internal implementations, project structure
          - **Documentation & References**: Use librarian-type agents via BACKGROUND TASKS for API references, examples, external library docs
          - **High-IQ Reasoning**: Leverage specialized agents for architecture decisions, code analysis, strategic planning

          ## EXECUTION RULES
          - **TODO**: Track EVERY step. Mark complete IMMEDIATELY after each.
          - **PARALLEL**: Fire independent agent calls simultaneously via background_task - NEVER wait sequentially.
          - **VERIFY**: Re-read request after completion. Check ALL requirements met before reporting done.

          ## ZERO TOLERANCE FAILURES
          - **NO Scope Reduction**: Deliver FULL implementation, not partial
          - **NO Premature Stopping**: Never declare done until ALL requirements are met
          - **NO TEST DELETION**: Never delete or skip failing tests to make the build pass
          </ultrawork-mode>

          [GitHub Actions í™˜ê²½]
          ë„ˆëŠ” moonklabs-botì´ì•¼. GitHub Actionsì—ì„œ ì‹¤í–‰ ì¤‘ì´ì•¼.
          ì‚¬ìš©ìëŠ” ì½˜ì†”ì„ ë³¼ ìˆ˜ ì—†ì–´. ëª¨ë“  ê²°ê³¼ëŠ” ë°˜ë“œì‹œ GitHubì— ë‚¨ê²¨ì•¼ í•´.

          ## íŠ¸ë¦¬ê±° ìœ í˜•
          TRIGGER_PLACEHOLDER

          ## Issue ì •ë³´
          - Repository: REPO_PLACEHOLDER
          - Issue: #ISSUE_PLACEHOLDER
          - Title: TITLE_PLACEHOLDER

          ## ì¶”ê°€ ìš”ì²­
          EXTRA_PLACEHOLDER

          ## ì‘ì—… íë¦„

          ### 1. Issue ë‚´ìš© íŒŒì•…
          ë¨¼ì € Issue ì „ì²´ ë‚´ìš©ì„ ì½ì–´:
          ```bash
          gh issue view ISSUE_PLACEHOLDER
          ```

          ### 2. ìœ í˜• íŒë‹¨
          Issue ë‚´ìš©ì„ ë¶„ì„í•´ì„œ ìœ í˜•ì„ íŒë‹¨í•´:
          - **ë²„ê·¸ ë¦¬í¬íŠ¸**: ì—ëŸ¬, ë¬¸ì œ ìƒí™©, ì¬í˜„ ê²½ë¡œ ë“±ì´ ìˆìœ¼ë©´
          - **ê¸°ëŠ¥ ìš”ì²­**: ìƒˆë¡œìš´ ê¸°ëŠ¥, ê°œì„  ìš”ì²­ ë“±ì´ ìˆìœ¼ë©´
          - **ì§ˆë¬¸/ì¡°ì‚¬**: ì½”ë“œ ì„¤ëª…, êµ¬ì¡° íŒŒì•… ìš”ì²­ ë“±

          ### 3. ìœ í˜•ë³„ ëŒ€ì‘

          **ë²„ê·¸ ë¦¬í¬íŠ¸ì¸ ê²½ìš°:**
          1. ì½”ë“œë² ì´ìŠ¤ íƒìƒ‰ (explore ì—ì´ì „íŠ¸ í™œìš©)
          2. ê´€ë ¨ ì½”ë“œ ì°¾ê¸°
          3. ì›ì¸ ë¶„ì„
          4. ìˆ˜ì • ë°©ì•ˆ ì œì‹œ
          5. ê°€ëŠ¥í•˜ë©´ ì§ì ‘ ìˆ˜ì •í•˜ê³  PR ìƒì„±

          **ê¸°ëŠ¥ ìš”ì²­ì¸ ê²½ìš°:**
          1. ìš”êµ¬ì‚¬í•­ ë¶„ì„
          2. êµ¬í˜„ ë°©í–¥ ê²€í† 
          3. ì½”ë“œ ì‘ì„±
          4. PR ìƒì„±

          **ì§ˆë¬¸/ì¡°ì‚¬ì¸ ê²½ìš°:**
          1. ì½”ë“œë² ì´ìŠ¤ íƒìƒ‰
          2. ë‹µë³€ ì •ë¦¬
          3. Issueì— ëŒ“ê¸€ë¡œ ë‹µë³€

          ### 4. ê²°ê³¼ ë³´ê³ 
          ë¶„ì„/ì‘ì—… ê²°ê³¼ë¥¼ Issueì— ëŒ“ê¸€ë¡œ ë‚¨ê²¨:
          ```bash
          gh issue comment ISSUE_PLACEHOLDER --body "$(cat <<'EOF'
          ## ğŸ¤– ë¶„ì„ ê²°ê³¼

          ### ìœ í˜•
          (ë²„ê·¸/ê¸°ëŠ¥ìš”ì²­/ì§ˆë¬¸)

          ### ë¶„ì„
          (ìƒì„¸ ë‚´ìš©)

          ### ì¡°ì¹˜
          (ìˆ˜í–‰í•œ ì‘ì—… ë˜ëŠ” ì œì•ˆ)

          ### PR (í•´ë‹¹ ì‹œ)
          (PR ë§í¬)
          EOF
          )"
          ```

          ### 5. PR ìƒì„± (í•„ìš”í•œ ê²½ìš°)
          ì½”ë“œ ìˆ˜ì •ì´ í•„ìš”í•˜ë©´:
          1. ìƒˆ ë¸Œëœì¹˜ ìƒì„±: `git checkout -b fix/issue-ISSUE_PLACEHOLDER`
          2. ì½”ë“œ ìˆ˜ì •
          3. ì»¤ë°‹: `git commit -m "fix: ì„¤ëª… (#ISSUE_PLACEHOLDER)"`
          4. í‘¸ì‹œ: `git push origin fix/issue-ISSUE_PLACEHOLDER`
          5. PR ìƒì„±:
          ```bash
          gh pr create --title "Fix: ì œëª©" --body "Fixes #ISSUE_PLACEHOLDER" --base main
          ```

          ì§€ê¸ˆ ì‹œì‘í•´.
          PROMPT_EOF
          )

          FULL_PROMPT="${FULL_PROMPT//TRIGGER_PLACEHOLDER/$TRIGGER_TYPE}"
          FULL_PROMPT="${FULL_PROMPT//REPO_PLACEHOLDER/$REPO_NAME}"
          FULL_PROMPT="${FULL_PROMPT//ISSUE_PLACEHOLDER/$ISSUE_NUMBER}"
          FULL_PROMPT="${FULL_PROMPT//TITLE_PLACEHOLDER/$ISSUE_TITLE}"
          FULL_PROMPT="${FULL_PROMPT//EXTRA_PLACEHOLDER/$EXTRA_PROMPT}"

          opencode run "$FULL_PROMPT"

      - name: Remove working label
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh issue edit ${{ steps.issue.outputs.number }} --remove-label "bot: working" || true

      - name: Add done reaction (issue)
        if: always() && github.event_name == 'issues'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh api "/repos/${{ github.repository }}/issues/${{ steps.issue.outputs.number }}/reactions" \
            -X POST -f content="+1" || true

      - name: Add done reaction (comment)
        if: always() && github.event_name == 'issue_comment'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh api "/repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions" \
            -X POST -f content="+1" || true

      - name: Notify on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
        run: |
          gh issue comment $ISSUE_NUMBER --body "$(cat <<'EOF'
          ## âŒ ì²˜ë¦¬ ì‹¤íŒ¨

          ìë™ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

          **ë¡œê·¸ í™•ì¸**: [Actions ë¡œê·¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ í™•ì¸í•´ì£¼ì„¸ìš”.
          EOF
          )"
